<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Collabs99 — Aptitude & Logic Quiz</title>
<meta name="description" content="Collabs99 student aptitude test: 50 questions with instant feedback, 60-minute timer, and Telegram result forwarding." />
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
  :root {
    --bg: #070b1a;
    --panel: rgba(255, 255, 255, .06);
    --stroke: rgba(255, 255, 255, .14);
    --text: #f5f8ff;
    --muted: rgba(245, 248, 255, .78);
    --cyan: #19d1d6;
    --fus: #e45ad2;
    --amb: #f6b73c;
    --lime: #3cf68a;
    --red: #ff4466;
    --blue: #4da6ff;
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    font-family: "Outfit", system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    color: var(--text);
    background: var(--bg);
    overflow-x: hidden;
    line-height: 1.6;
  }
  a { color: inherit; text-decoration: none; }
  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 18px 20px;
  }

  /* --- Animated Background --- */
  .bg {
    position: fixed;
    inset: 0;
    z-index: -3;
    background: radial-gradient(60% 40% at -10% 10%, rgba(25, 209, 214, .22), transparent 60%), radial-gradient(60% 40% at 110% 30%, rgba(228, 90, 210, .18), transparent 60%), radial-gradient(70% 50% at 50% 120%, rgba(246, 183, 60, .15), transparent 60%);
  }
  .grid {
    position: fixed;
    inset: 0;
    z-index: -2;
    opacity: .25;
    background-image: linear-gradient(to right, rgba(255, 255, 255, .08) 1px, transparent 1px), linear-gradient(to bottom, rgba(255, 255, 255, .08) 1px, transparent 1px);
    background-size: 40px 40px;
  }
  .orb {
    position: fixed;
    filter: blur(60px);
    border-radius: 999px;
    z-index: -1;
    mix-blend-mode: screen;
    animation: float 14s ease-in-out infinite;
  }
  .orb.a { width: 28rem; height: 28rem; left: -8rem; top: -6rem; background: radial-gradient(circle at 30% 30%, rgba(25, 209, 214, .5), transparent 60%); }
  .orb.b { width: 26rem; height: 26rem; right: -8rem; top: 10%; background: radial-gradient(circle at 60% 40%, rgba(228, 90, 210, .45), transparent 60%); animation-duration: 18s; }
  .orb.c { width: 30rem; height: 30rem; left: 10%; bottom: -10rem; background: radial-gradient(circle at 50% 50%, rgba(246, 183, 60, .45), transparent 60%); animation-duration: 20s; }
  @keyframes float { 0% { transform: translateY(0); } 50% { transform: translateY(18px); } 100% { transform: translateY(0); } }

  /* --- Header --- */
  header {
    position: sticky;
    top: 0;
    z-index: 50;
    backdrop-filter: blur(10px);
    background: rgba(7, 11, 26, .55);
    border-bottom: 1px solid var(--stroke);
  }
  header .container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 14px;
    padding: 12px 20px;
  }
  .brand { display: flex; align-items: center; gap: 12px; }
  .logo {
    width: 64px;
    height: 44px;
    border-radius: 14px;
    position: relative;
    background: linear-gradient(135deg, var(--cyan), var(--fus));
    box-shadow: 0 0 30px rgba(25, 209, 214, .45), 0 0 60px rgba(228, 90, 210, .35);
  }
  .logo:after {
    content: "99";
    position: absolute;
    inset: 3px;
    display: grid;
    place-items: center;
    border-radius: 10px;
    background: #0b1020;
    color: #fff;
    font-weight: 900;
    letter-spacing: -.02em;
    border: 1px solid rgba(255, 255, 255, .22);
  }
  .title { font-weight: 900; letter-spacing: -.02em; font-size: clamp(24px, 4.6vw, 42px); }
  .sub { color: var(--muted); font-size: 13px; }
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 999px;
    background: rgba(255, 255, 255, .08);
    border: 1px solid var(--stroke);
    color: var(--muted);
    font-size: 12px;
  }
  .timer {
    font-variant-numeric: tabular-nums;
    font-weight: 900;
    font-size: clamp(16px, 3.6vw, 20px);
    color: var(--text);
  }

  /* --- Panels / Cards --- */
  .panel {
    background: var(--panel);
    border: 1px solid var(--stroke);
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, .35), inset 0 0 40px rgba(255, 255, 255, .04);
  }

  /* --- Modals --- */
  .modal {
    position: fixed;
    inset: 0;
    display: grid;
    place-items: center;
    background: rgba(5, 7, 16, .6);
    backdrop-filter: blur(8px);
    z-index: 100;
  }
  .start-card {
    width: min(520px, 94vw);
    padding: 24px;
    border-radius: 22px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .start-head { text-align: center; }
  .start-head .tt { font-size: clamp(18px, 2.8vw, 24px); font-weight: 800; }
  .glow { background: linear-gradient(90deg, var(--cyan), var(--fus)); height: 2px; border-radius: 999px; }
  .form-grid { display: flex; flex-direction: column; gap: 14px; }
  label { font-size: 13px; color: var(--muted); }
  input {
    width: 100%;
    padding: 12px 16px;
    border-radius: 14px;
    background: rgba(255, 255, 255, .08);
    color: #fff;
    border: 1px solid var(--stroke);
    font-size: 16px;
  }
  input:focus { outline: none; border-color: var(--cyan); box-shadow: 0 0 0 2px rgba(25, 209, 214, .2); }
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 16px;
    border-radius: 14px;
    border: 1px solid rgba(255, 255, 255, .22);
    font-weight: 700;
    cursor: pointer;
    transition: .25s;
    font-size: 16px;
  }
  .btn:disabled { cursor: not-allowed; opacity: 0.6; }
  .btn.primary {
    background: linear-gradient(90deg, var(--fus), var(--cyan));
    box-shadow: 0 0 30px rgba(25, 209, 214, .35);
  }
  .btn.primary:hover:not(:disabled) { transform: translateY(-2px); }
  .btn-group {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 6px;
  }
  
  /* Message display styling */
  .form-message {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
      min-height: 1.6em; /* Prevents layout shift */
      transition: color .3s ease;
      font-weight: 600;
  }
  .form-message.error {
      color: var(--red);
  }
  .form-message.info {
      color: var(--amb);
  }

  #prevBtn {
    background: linear-gradient(90deg, var(--fus), var(--cyan));
    box-shadow: 0 0 30px rgba(25, 209, 214, .35);
    color: #000;
  }
 #modalCancelBtn {
    background: linear-gradient(90deg, #003300, var(--cyan));
box-shadow: 0 0 30px rgba(0, 40, 0, .35);
    color: #000;
  }
  .instructions {
    text-align: left;
    padding-left: 20px;
    font-size: 15px;
    color: var(--muted);
  }
  .instructions li { margin-bottom: 8px; }

  /* --- Quiz Layout --- */
  .quiz-wrap {
    display: grid;
    grid-template-columns: 1fr;
    gap: 18px;
  }
  @media (min-width: 900px) {
    .quiz-wrap { grid-template-columns: 1.1fr .9fr; }
  }
  .hud {
    padding: 14px;
    order: -1;
  }
  @media (min-width: 900px) {
    .hud { order: 0; }
  }
  .stat { display: flex; justify-content: space-around; gap: 10px; }
  .kpi {
    padding: 12px;
    border-radius: 16px;
    text-align: center;
    background: linear-gradient(135deg, rgba(25, 209, 214, .16), rgba(228, 90, 210, .16));
    flex: 1;
    word-wrap: break-word; /* Helps with long words in details */
  }
  .big { font-size: clamp(18px, 3.6vw, 26px); font-weight: 900; }
  .muted { color: var(--muted); }
  .bar { height: 12px; background: rgba(255, 255, 255, .12); border-radius: 999px; overflow: hidden; }
  .bar > i { display: block; height: 100%; width: 0%; background: linear-gradient(90deg, var(--cyan), var(--fus)); transition: width .5s; }

  .qcard { padding: 18px; }
  .qno { font-size: 14px; color: var(--muted); }
  .qtext { font-size: clamp(18px, 2.4vw, 22px); font-weight: 800; margin: 8px 0 10px; }
  .opts { display: flex; flex-direction: column; gap: 10px; }
  .opt {
    position: relative;
    padding: 14px 16px;
    border-radius: 14px;
    border: 1px solid var(--stroke);
    background: rgba(255, 255, 255, .06);
    cursor: pointer;
    transition: .2s;
  }
  .opt:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0, 0, 0, .35); }
  .opt.correct { background: linear-gradient(135deg, rgba(60, 246, 138, .18), rgba(60, 246, 138, .08)); border-color: rgba(60, 246, 138, .55); }
  .opt.wrong { background: linear-gradient(135deg, rgba(255, 68, 102, .22), rgba(255, 68, 102, .08)); border-color: rgba(255, 68, 102, .55); }
  .controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 16px;
    justify-content: space-between;
  }
  .controls .btn { flex-grow: 1; }
  @media (min-width: 500px) {
    .controls .btn { flex-grow: 0; }
  }

  .ghost { background: transparent; }
  .grid-jump {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
    gap: 8px;
    margin-top: 8px;
  }
  .grid-jump .btn { padding: 8px 0; border-radius: 10px; font-weight: normal; }

  /* --- 3D cube accent --- */
  .cube-wrap {
    display: grid;
    place-items: center;
  }
  .cube {
    width: min(72vmin, 320px);
    height: min(72vmin, 320px);
    transform-style: preserve-3d;
    animation: spin 18s linear infinite;
  }
  .face {
    position: absolute;
    inset: 0;
    border-radius: 22px;
    border: 2px solid;
    background: linear-gradient(135deg, rgba(25, 209, 214, .12), rgba(228, 90, 210, .12));
    box-shadow: 0 0 50px rgba(25, 209, 214, .18) inset;
  }
  .f1 { transform: translateZ(120px); border-color: rgba(25, 209, 214, .6); }
  .f2 { transform: rotateY(90deg) translateZ(120px); border-color: rgba(228, 90, 210, .6); }
  .f3 { transform: rotateY(180deg) translateZ(120px); border-color: rgba(246, 183, 60, .6); }
  .f4 { transform: rotateY(-90deg) translateZ(120px); border-color: rgba(25, 209, 214, .6); }
  .f5 { transform: rotateX(90deg) translateZ(120px); border-color: rgba(228, 90, 210, .6); }
  .f6 { transform: rotateX(-90deg) translateZ(120px); border-color: rgba(246, 183, 60, .6); }
  @keyframes spin { from { transform: rotateY(0); } to { transform: rotateY(360deg); } }

  /* --- Result Screen --- */
  .result { display: none; padding: 18px; }
  .score-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 12px;
  }
  .btn-results {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 16px;
  }
  @media print {
    .modal, .video-proctor-container, .audio-proctor-container { display: none !important; }
    header { position: static; }
    .bg, .grid, .orb, .cube-wrap { display: none !important; }
    .btn-results { display: none; }
  }

  /* --- Anti-Cheating Styles --- */
  body {
    -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
  }
  
  /* --- Success Animation Styles --- */
  .success-container {
    text-align: center;
    margin-top: 24px;
  }
  .checkmark {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: block;
    stroke-width: 3;
    stroke: var(--lime);
    stroke-miterlimit: 10;
    margin: 10px auto;
    box-shadow: inset 0px 0px 0px var(--lime);
    animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
  }
  .checkmark__circle {
    stroke-dasharray: 166;
    stroke-dashoffset: 166;
    stroke-width: 3;
    stroke-miterlimit: 10;
    stroke: var(--lime);
    fill: none;
    animation: stroke .6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
  }
  .checkmark__check {
    transform-origin: 50% 50%;
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards;
  }
  @keyframes stroke {
    100% { stroke-dashoffset: 0; }
  }
  @keyframes scale {
    0%, 100% { transform: none; }
    50% { transform: scale3d(1.1, 1.1, 1); }
  }
  @keyframes fill {
    100% { box-shadow: inset 0px 0px 0px 40px var(--lime); }
  }
  .success-container p {
    color: var(--muted);
    font-size: 14px;
  }
  
  /* --- NEW PROCTORING STYLES --- */
  .proctor-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--muted);
    background: rgba(0,0,0,0.3);
    padding: 4px 8px;
    border-radius: 8px;
  }
  .proctor-indicator::before {
    content: '';
    width: 8px;
    height: 8px;
    background: var(--red);
    border-radius: 50%;
    animation: blink 1.2s infinite;
  }
  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Video Proctor */
  .video-proctor-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 200;
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }
  #proctor-preview {
    width: 150px;
    height: 150px;
    position: relative;
    border-radius: 50%;
    overflow: hidden;
    transition: box-shadow 0.3s ease-in-out;
    background: #000;
  }
  #proctor-preview video, #proctor-preview canvas {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) scaleX(-1) scale(1.3); /* Mirror video and scale */
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .glow-green {
    box-shadow: 0 0 12px 4px var(--lime);
  }
  .glow-red {
    box-shadow: 0 0 15px 5px var(--red);
    animation: pulse-red 1s infinite alternate;
  }
  @keyframes pulse-red {
    from { box-shadow: 0 0 15px 5px rgba(255, 68, 102, 0.6); }
    to { box-shadow: 0 0 22px 7px rgba(255, 68, 102, 0.9); }
  }
  #proctor-scan-bar {
    position: absolute;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, transparent, rgba(255, 68, 102, 0.8), transparent);
    box-shadow: 0 0 6px var(--red);
    top: 0;
    left: 0;
    z-index: 10;
    animation: scan 2.5s linear infinite alternate;
  }
  @keyframes scan {
    from { top: 0%; }
    to { top: calc(100% - 3px); }
  }

  /* Audio Proctor */
  .audio-proctor-container {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 200;
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }
  #audio-canvas {
    width: 180px;
    height: 80px;
    background: var(--panel);
    border-radius: 16px;
    border: 1px solid var(--stroke);
  }
  
  .secure-connection-error {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--bg);
      color: var(--text);
      z-index: 9999;
      place-content: center;
      text-align: center;
      font-size: 1.2rem;
      padding: 2rem;
  }

  /* Mobile Layout Adjustment for Proctoring Widgets */
  @media (max-width: 768px) {
    .video-proctor-container, .audio-proctor-container {
        bottom: 90px; /* Raise widgets above control buttons */
    }
    .video-proctor-container {
        right: 10px;
    }
    #proctor-preview {
        width: 120px;
        height: 120px;
    }
    .audio-proctor-container {
        left: 10px;
    }
    #audio-canvas {
        width: 120px;
        height: 60px;
    }
    .proctor-indicator {
        font-size: 9px;
    }
  }

</style>
</head>
<body>

  <div class="secure-connection-error" id="secureConnectionError">
    <div>
      <p style="font-weight: bold; font-size: 1.5rem;">Secure Connection Required</p>
      <p>Proctoring features require a secure (HTTPS) connection.</p>
      <p>Please ensure you are accessing this page via a valid HTTPS link.</p>
    </div>
  </div>

  <div class="bg"></div>
  <div class="grid"></div>
  <div class="orb a"></div>
  <div class="orb b"></div>
  <div class="orb c"></div>
  <header>
    <div class="container">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Collabs99</div>
          <div class="sub">Ultra‑Futuristic Aptitude & Logic Quiz • 50 Questions • 60‑minute Timer</div>
        </div>
      </div>
      <div class="badge"><span class="timer" id="timerDisplay">60:00</span> left</div>
    </div>
  </header>
  <div class="modal" id="startModal">
    <div class="panel start-card">
      <div class="start-head">
        <div class="brand" style="gap:10px; justify-content:center;">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <div class="tt">Collabs99 — Candidate Details</div>
            <div class="sub">Please fill your details to begin. Timer starts after you click <b>Start Test</b>.</div>
          </div>
        </div>
      </div>
      <div class="glow"></div>
      <form id="candidateForm" class="form-grid">
        <div>
          <label for="name">Full Name</label>
          <input id="name" name="name" placeholder="e.g., Kundan Prasad Yadav" required />
        </div>
        <div>
          <label for="college">College</label>
          <input id="college" name="college" placeholder="e.g., XYZ Institute of Technology" required />
        </div>
        <div>
          <label for="email">Gmail</label>
          <input id="email" type="email" name="email" placeholder="yourname@gmail.com" required />
        </div>
        <div>
          <label for="collabId">Collab99 ID</label>
          <input id="collabId" name="collabId" placeholder="e.g., C99-2025-XXXXX" required />
        </div>
        <div>
            <label for="otp">OTP</label>
            <input id="otp" type="password" name="otp" placeholder="e.g., 123" required />
        </div>
        <div class="btn-group">
          <button type="button" class="btn ghost" onclick="document.getElementById('candidateForm').reset(); document.getElementById('formMessage').textContent = '';">Reset</button>
          <button type="submit" class="btn primary">Start Test ▶</button>
        </div>
        <div id="formMessage" class="form-message"></div>
      </form>
    </div>
  </div>
  <main class="container" style="margin-top:16px">
    <div class="quiz-wrap">
      <section class="panel qcard">
        <div class="qno" id="qNumber">Question 1 / 50</div>
        <div class="qtext" id="qText">Loading…</div>
        <div class="opts" id="options"></div>
        <div class="controls">
          <button class="btn ghost" id="prevBtn">◀ Prev</button>
          <button class="btn primary" id="nextBtn">Next ▶</button>
        </div>
        <div id="finalSubmitContainer" style="display: none; margin-top: 16px;">
            <button id="finalSubmitBtn" class="btn" style="width: 100%; background: var(--lime); color: #000; font-weight: 900; letter-spacing: .02em;">Submit Test</button>
        </div>
      </section>
      <aside class="panel hud">
        <div class="stat">
          <div class="kpi"><div class="muted">Attempted</div><div class="big" id="attempted">0</div></div>
          <div class="kpi"><div class="muted">Correct</div><div class="big" id="correct">0</div></div>
        </div>
        <div style="margin:12px 0 6px" class="muted">Progress</div>
        <div class="bar"><i id="progressBar"></i></div>
        <div style="margin-top:16px" class="muted">Quick Jump</div>
        <div id="grid" class="grid-jump"></div>
        <div class="cube-wrap" style="margin-top:20px">
          <div class="cube" aria-hidden="true">
            <div class="face f1"></div><div class="face f2"></div><div class="face f3"></div>
            <div class="face f4"></div><div class="face f5"></div><div class="face f6"></div>
          </div>
        </div>
      </aside>
    </div>
    <section class="panel result" id="resultPanel">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
        <div>
          <div class="title">Your Result</div>
          <div class="sub">Great effort! See your performance summary below.</div>
        </div>
        <div class="badge">⏱ <span id="timeUsed">—</span> used</div>
      </div>
      <div class="glow" style="margin:10px 0 16px"></div>
      <div class="score-grid">
        <div class="kpi"><div class="muted">Name</div><div class="big" id="rName">—</div></div>
        <div class="kpi"><div class="muted">College</div><div class="big" id="rCollege">—</div></div>
        <div class="kpi"><div class="muted">Collab99 ID</div><div class="big" id="rAptId">—</div></div>
        <div class="kpi"><div class="muted">Attempted</div><div class="big" id="rAttempted">—</div></div>
        <div class="kpi"><div class="muted">Correct</div><div class="big" id="rCorrect">—</div></div>
        <div class="kpi"><div class="muted">Score</div><div class="big" id="rScore">—</div></div>
        <div class="kpi"><div class="muted" style="color:var(--lime)">OK Time (Face / Audio)</div><div class="big" id="rProctorOK">—</div></div>
        <div class="kpi"><div class="muted" style="color:var(--red)">Alert Time (Face / Audio)</div><div class="big" id="rProctorAlerts">—</div></div>
      </div>
      <div class="btn-results">
        <button class="btn primary" onclick="window.print()">Print / Save PDF</button>
        </div>
      <div id="successAnimation" class="success-container" style="display: none;">
          <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
              <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
              <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
          </svg>
          <p>Your Data has been recorded. Now you can leave.</p>
      </div>
    </section>
  </main>

  <div class="modal" id="customModal" style="display: none;">
    <div class="panel start-card">
      <div class="start-head">
        <div class="tt" id="modalTitle">Modal Title</div>
        <div id="modalBody" style="margin-top: 12px;"></div>
      </div>
      <div class="glow"></div>
      <div class="btn-group" id="modalBtnGroup" style="margin-top: 16px;">
        <button id="modalCancelBtn" class="btn ghost">Cancel</button>
        <button id="modalConfirmBtn" class="btn primary">Confirm</button>
      </div>
    </div>
  </div>

  <div class="video-proctor-container" id="videoProctorContainer">
      <div id="proctor-preview">
          <video id="proctor-video" playsinline></video>
          <canvas id="proctor-canvas"></canvas>
          <div id="proctor-scan-bar"></div>
      </div>
      <div class="proctor-indicator">
          Video recording and streaming on server
      </div>
  </div>
  <div class="audio-proctor-container" id="audioProctorContainer">
    <canvas id="audio-canvas"></canvas>
    <div class="proctor-indicator">
        Audio recording and streaming on server
    </div>
  </div>

<script>
// ==========================
//  INITIAL SECURITY CHECK
// ==========================
if (window.location.protocol !== "https:" && !['localhost', '127.0.0.1'].includes(window.location.hostname)) {
    document.getElementById('secureConnectionError').style.display = 'grid';
}

// ==========================
//  ACCESS & AUTH CONFIG
// ==========================
const accessStartTime = new Date('2025-08-21T15:46:00+05:30');
const accessEndTime = new Date('2025-08-21T17:00:00+05:30');
const specialUser = "C99-2025-000";
const encodedAuthData = "eyJDOTktMjAyNS0wMDAiOiIwMDAiLCJDOTktMjAyNS0wMTAiOiI5ODMiLCJDOTktMjAyNS0wMjAiOiI3NDIiLCJDOTktMjAyNS0wMzAiOiI2MTUiLCJDOTktMjAyNS0wNDAiOiIyMDEiLCJDOTktMjAyNS0wNTAiOiI4NDkiLCJDOTktMjAyNS0wNjAiOiIzNTciLCJDOTktMjAyNS0wNzAiOiI2OTQiLCJDOTktMjAyNS0wODAiOiI1NzgiLCJDOTktMjAyNS0wOTAiOiI0NjMiLCJDOTktMjAyNS0xMDAiOiI5MjAiLCJDOTktMjAyNS0xMTAiOiIzMzEiLCJDOTktMjAyNS0xMjAiOiI3NTciLCJDOTktMjAyNS0xMzAiOiI0MTIiLCJDOTktMjAyNS0xNDAiOiI2ODYiLCJDOTktMjAyNS0xNTAiOiIzMDUiLCJDOTktMjAyNS0xNjAiOiI4NDEiLCJDOTktMjAyNS0xNzAiOiIyMzgiLCJDOTktMjAyNS0xODAiOiI5MTQiLCJDOTktMjAyNS0xOTAiOiI1MDciLCJDOTktMjAyNS0yMDAiOiIzNjkiLCJDOTktMjAyNS0yMTAiOiI4MjQiLCJDOTktMjAyNS0yMjAiOiI2OTciLCJDOTktMjAyNS0yMzAiOiI1OTMiLCJDOTktMjAyNS0yNDAiOiI0ODIiLCJDOTktMjAyNS0yNTAiOiI3NjUiLCJDOTktMjAyNS0yNjAiOiIyOTEiLCJDOTktMjAyNS0yNzAiOiI2MzkiLCJDOTktMjAyNS0yODAiOiI4NzUiLCJDOTktMjAyNS0yOTAiOiI0MjMiLCJDOTktMjAyNS0zMDAiOiI5NjgiLCJDOTktMjAyNS0zMTAiOiI1MTIiLCJDOTktMjAyNS0zMjAiOiIzODYiLCJDOTktMjAyNS0zMzAiOiI3NDkiLCJDOTktMjAyNS0zNDAiOiIyNTgiLCJDOTktMjAyNS0zNTAiOiI5MzciLCJDOTktMjAyNS0zNjAiOiI2NTQiLCJDOTktMjAyNS0zNzAiOiI0NzMiLCJDOTktMjAyNS0zODAiOiI4MDkiLCJDOTktMjAyNS0zOTAiOiI1MjEiLCJDOTktMjAyNS00MDAiOiI2OTgiLCJDOTktMjAyNS00MTAiOiIzNDUiLCJDOTktMjAyNS00MjAiOiI4NzYiLCJDOTktMjAyNS00MzAiOiIyMTkiLCJDOTktMjAyNS00NDAiOiI2NDMiLCJDOTktMjAyNS00NTAiOiI5OTQiLCJDOTktMjAyNS00NjAiOiI3MzAiLCJDOTktMjAyNS00NzAiOiI1NjkiLCJDOTktMjAyNS00ODAiOiI0NjciLCJDOTktMjAyNS00OTAiOiI3MDIiLCJDOTktMjAyNS01MDAiOiI4ODMifQ==";
const credentials = JSON.parse(atob(encodedAuthData));

// ==========================
//  CONFIG — TELEGRAM
// ==========================
const TG = {
  enabled: true,
  BOT_TOKEN: "8088826825:AAE48g9H4e2rXZ0KKoUIXbPo5AUeMxdHSEE",
  CHAT_ID: "5726860669"
};

// ==========================
//  QUESTIONS (50 TOTAL)
// ==========================
const QUESTIONS = [
  {q:"You have 12 coins; one is counterfeit and either heavier or lighter. Using a balance scale only 3 weighings, can you always identify the counterfeit coin and whether it’s heavier or lighter?", a:["No, impossible","Yes, always possible","Only if heavier","Only if lighter"], c:1},
  {q:"A prisoner must choose one of three doors: behind one is freedom; behind the other two, tigers. After he picks, the warden opens a different door showing a tiger and offers a switch. To maximize survival, he should…", a:["Stay","Switch","Randomize","It doesn’t matter"], c:1},
  {q:"Two trains 120 km apart approach each other at 30 km/h and 50 km/h. A bee flies back and forth between them at 60 km/h until they collide. Total distance flown by the bee?", a:["90 km","100 km","120 km","80 km"], c:3},
  {q:"You have a 3L and a 5L jug. Measure exactly 4L. Minimum steps?", a:["3","4","5","6"], c:2},
  {q:"A fair coin is tossed until two consecutive heads appear. Expected number of tosses?", a:["4","6","5","3"], c:2},
  {q:"There are 100 lockers all closed. You toggle every kth locker on pass k (k=1..100). How many remain open?", a:["10","50","9","11"], c:3},
  {q:"You randomly permute numbers 1..n. Expected number of fixed points (i such that p(i)=i)?", a:["0","1","ln n","n/2"], c:1},
  {q:"In a party, everyone shakes hands; no one shakes with themselves. If there are N people, how many handshakes?", a:["N(N-1)","N^2/2","N(N-1)/2","(N-1)/2"], c:2},
  {q:"A graph with V vertices and at least (V-1) edges that is connected and has no cycles is a…", a:["DAG","Tree","Forest","Bipartite"], c:1},
  {q:"Choose the next number: 1, 2, 4, 7, 11, 16, ?", a:["20","21","22","23"], c:3},
  {q:"Which data structure follows FIFO (First In First Out)?", a:["Stack","Queue","Tree","Graph"], c:1},
  {q:"What is the time complexity of accessing an element in an array by index?", a:["O(n)","O(1)","O(log n)","O(n log n)"], c:1},
  {q:"Which sorting algorithm is the fastest on average?", a:["Bubble Sort","Selection Sort","Quick Sort","Insertion Sort"], c:2},
  {q:"Which of these is not a linear data structure?", a:["Array","Linked List","Tree","Queue"], c:2},
  {q:"Which data structure is used in recursion?", a:["Queue","Stack","Heap","Graph"], c:1},
  {q:"What is the worst-case time complexity of binary search?", a:["O(n)","O(log n)","O(n log n)","O(1)"], c:1},
  {q:"In a linked list, insertion at the beginning takes?", a:["O(n)","O(log n)","O(1)","O(n²)"], c:2},
  {q:"Which algorithm is used to find the shortest path in a graph?", a:["BFS","DFS","Merge Sort","Quick Sort"], c:0},
  {q:"Which of these uses dynamic programming?", a:["Fibonacci Series","Bubble Sort","Binary Search","Tower of Hanoi"], c:0},
  {q:"Which of these is a frontend technology?", a:["Node.js","React","MongoDB","Express"], c:1},
  {q:"Which database is NoSQL?", a:["MySQL","PostgreSQL","MongoDB","Oracle"], c:2},
  {q:"Which tag is used for inserting an image in HTML?", a:["<p>","<img>","<div>","<span>"], c:1},
  {q:"Which CSS property changes text color?", a:["font-size","background-color","color","text-align"], c:2},
  {q:"Which of the following is a backend framework?", a:["Angular","Vue.js","Express.js","Bootstrap"], c:2},
  {q:"What is the extension of a JavaScript file?", a:[".java",".js",".jsx",".script"], c:1},
  {q:"Which HTTP method is used to fetch data?", a:["GET","POST","PUT","DELETE"], c:0},
  {q:"Which protocol is used for secure communication on the web?", a:["HTTP","HTTPS","FTP","SMTP"], c:1},
  {q:"Which cloud platform provides AWS Lambda?", a:["Google Cloud","Microsoft Azure","AWS","Oracle"], c:2},
  {q:"Which traversal of a BST prints nodes in sorted order?", a:["Preorder","Postorder","Inorder","Level order"], c:2},
  {q:"What is the space complexity of Merge Sort?", a:["O(1)","O(n)","O(log n)","O(n²)"], c:1},
  {q:"Which hashing technique resolves collisions by storing multiple elements in the same bucket?", a:["Linear Probing","Quadratic Probing","Chaining","Double Hashing"], c:2},
  {q:"In React, which hook is used to manage state?", a:["useEffect","useState","useContext","useRef"], c:1},
  {q:"Which SQL query retrieves all rows where salary > 50000?", a:["SELECT salary > 50000 FROM employee;","SELECT * FROM employee WHERE salary > 50000;","SELECT employee WHERE salary > 50000;","SELECT * salary FROM employee;"], c:1},
  {q:"In REST API, which status code indicates 'Resource Not Found'?", a:["200","400","404","500"], c:2},
  {q:"Which of these problems can’t be solved in polynomial time unless P=NP?", a:["Sorting","Traveling Salesman Problem","Searching","Graph Traversal"], c:1},
  {q:"If a graph has V vertices and E edges, what is the time complexity of Kruskal’s algorithm?", a:["O(V²)","O(E log V)","O(V log V)","O(E+V)"], c:1},
  {q:"Which data structure can implement an efficient LRU cache?", a:["Stack + Array","HashMap + Doubly Linked List","Queue + BST","Array + Heap"], c:1},
  {q:"Which of the following improves website performance the most for large-scale apps?", a:["CSS Styling","Server-Side Rendering","Adding Images","Increasing Font Size"], c:1},
  {q:"Which database isolation level prevents both Dirty Read and Non-Repeatable Read?", a:["Read Uncommitted","Read Committed","Repeatable Read","Serializable"], c:2},
  {q:"In microservices, which pattern ensures service availability even when some services fail?", a:["Singleton Pattern","Circuit Breaker","Observer Pattern","MVC"], c:1},
  {q:"You choose uniformly from integers 1..100. What is the probability the number is divisible by 2 or 5?", a:["0.6","0.7","0.5","0.65"], c:0},
  {q:"Minimum number of colors needed to color any planar graph so adjacent vertices differ?", a:["3","4","5","6"], c:1},
  {q:"You roll two fair dice. Probability sum equals 9?", a:["1/9","1/12","1/8","1/6"], c:0},
  {q:"Asymptotically tight bound of 1 + 2 + … + n?", a:["Θ(n)","Θ(n log n)","Θ(n²)","Θ(log n)"], c:2},
  {q:"Dijkstra’s algorithm fails with negative edges unless you…", a:["Use min-heap","Reweight edges (Johnson)","Sort edges","Use adjacency matrix"], c:1},
  {q:"In consistent hashing, adding a node affects roughly what fraction of keys?", a:["1/N","1/2","All","log N"], c:0},
  {q:"What’s the entropy (in bits) of a fair 8-sided die roll?", a:["2","3","log2(8)=3","8"], c:2},
  {q:"For a min-cut in a graph, which theorem links max-flow to min-cut?", a:["Menger’s","Max-Flow Min-Cut","Hall’s","Dilworth’s"], c:1},
  {q:"Time complexity to build a heap from n elements (bottom-up)?", a:["O(n)","O(n log n)","O(log n)","O(n²)"], c:0},
  {q:"Which data structure gives amortized O(1) push/pop at both ends and O(1) random access?", a:["Deque","Vector (dynamic array)","Linked list","Skip list"], c:1}
];

// ==============
//  QUIZ STATE
// ==============
let iQ = 0;
const totalQ = QUESTIONS.length;
let picked = new Array(totalQ).fill(null);
let correctCount = 0;
let startTs = null;
let timerId = null;
let remaining = 60 * 60; 
let candidate = { name: "", college: "", email: "", aptId: "" };
let quizFinalized = false;

// ==============
//  PROCTORING STATE
// ==============
let proctoringActive = false;
// Video
let refGaze = null, refEyeRatios = null;
const modelURL = "https://justadudewhohacks.github.io/face-api.js/models";
let videoRedAlertStartTime = null, greenStateStartTime = null;
let totalVideoRedAlertDuration = 0, totalGreenStateDuration = 0; // in milliseconds
let currentVideoProctorState = 'green';
// Audio
let audioRedAlertStartTime = null;
let totalAudioRedAlertDuration = 0; // in milliseconds
let currentAudioProctorState = 'green';


// ==============
//  UI ELEMENTS
// ==============
const qNumber = document.getElementById('qNumber');
const qText = document.getElementById('qText');
const optionsEl = document.getElementById('options');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const finalSubmitContainer = document.getElementById('finalSubmitContainer');
const finalSubmitBtn = document.getElementById('finalSubmitBtn');
const attemptedEl = document.getElementById('attempted');
const correctEl = document.getElementById('correct');
const bar = document.getElementById('progressBar');
const grid = document.getElementById('grid');
const timerDisplay = document.getElementById('timerDisplay');
const startModal = document.getElementById('startModal');
const form = document.getElementById('candidateForm');
const formMessageEl = document.getElementById('formMessage');
const resultPanel = document.getElementById('resultPanel');
const rName = document.getElementById('rName'), rCollege = document.getElementById('rCollege'), rAptId = document.getElementById('rAptId');
const rAttempted = document.getElementById('rAttempted'), rCorrect = document.getElementById('rCorrect'), rScore = document.getElementById('rScore');
const rProctorOK = document.getElementById('rProctorOK'), rProctorAlerts = document.getElementById('rProctorAlerts');
const timeUsed = document.getElementById('timeUsed');
const successAnimation = document.getElementById('successAnimation');
const customModal = document.getElementById('customModal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalBtnGroup = document.getElementById('modalBtnGroup');
const modalConfirmBtn = document.getElementById('modalConfirmBtn');
const modalCancelBtn = document.getElementById('modalCancelBtn');

// Proctoring UI elements
const videoProctorContainer = document.getElementById('videoProctorContainer');
const proctorPreview = document.getElementById('proctor-preview');
const proctorVideo = document.getElementById('proctor-video');
const proctorCanvas = document.getElementById('proctor-canvas');
const proctorCtx = proctorCanvas.getContext('2d');
const audioProctorContainer = document.getElementById('audioProctorContainer');
const audioCanvas = document.getElementById('audio-canvas');
const audioCanvasCtx = audioCanvas.getContext('2d');

// ==========================================
//  MODAL & ANTI-CHEATING LOGIC
// ==========================================

function showModal(config) {
    modalTitle.textContent = config.title;
    modalBody.innerHTML = config.body;
    modalConfirmBtn.textContent = config.confirmText;
    modalConfirmBtn.onclick = config.onConfirm;

    if (config.cancelText) {
        modalCancelBtn.style.display = 'inline-flex';
        modalCancelBtn.textContent = config.cancelText;
        modalCancelBtn.onclick = config.onCancel;
        modalBtnGroup.style.justifyContent = 'flex-end';
    } else {
        modalCancelBtn.style.display = 'none';
        modalBtnGroup.style.justifyContent = 'center'; 
    }
    customModal.style.display = 'grid';
}

function hideModal() { customModal.style.display = 'none'; }

function enterFullScreen() {
  const element = document.documentElement;
  if (element.requestFullscreen) { element.requestFullscreen().catch(err => console.warn(`Could not enter fullscreen: ${err.message}`)); } 
  else if (element.mozRequestFullScreen) { element.mozRequestFullScreen(); }
  else if (element.webkitRequestFullscreen) { element.webkitRequestFullscreen(); }
  else if (element.msRequestFullscreen) { element.msRequestFullscreen(); }
}

document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement && startTs !== null && !quizFinalized) {
    showModal({
        title: "Warning: Are you sure?",
        body: `<p class="sub">Leaving the test will automatically submit your current progress.</p>`,
        confirmText: "OK, Submit",
        cancelText: "Cancel",
        onConfirm: () => { hideModal(); finalize(); },
        onCancel: () => { hideModal(); enterFullScreen(); }
    });
  }
});

window.addEventListener('popstate', () => {
    if (startTs !== null && !quizFinalized) {
        history.pushState(null, null, location.href);
        showModal({
            title: "Warning: Are you sure?",
            body: `<p class="sub">Going back will automatically submit your current progress.</p>`,
            confirmText: "OK, Submit",
            cancelText: "Cancel",
            onConfirm: () => { hideModal(); finalize(); },
            onCancel: hideModal
        });
    }
});

const warningMessage = "Warning !! Don't try to copy paste , we are able to know this .";
document.addEventListener('copy', (e) => {
  e.preventDefault();
  if (e.clipboardData) { e.clipboardData.setData('text/plain', warningMessage); }
});
document.addEventListener('contextmenu', (e) => { e.preventDefault(); });
document.addEventListener('keydown', (e) => {
  if (e.keyCode === 123 || (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) || (e.ctrlKey && e.keyCode === 85)) { e.preventDefault(); }
  if (e.ctrlKey && (e.keyCode === 67 || e.keyCode === 88 || e.keyCode === 83)) { e.preventDefault(); }
});

// ==========================================
//  PROCTORING CORE LOGIC
// ==========================================

async function loadModels(){
  displayFormMessage('Loading AI models...', 'info');
  await faceapi.nets.tinyFaceDetector.loadFromUri(modelURL);
  await faceapi.nets.faceLandmark68TinyNet.loadFromUri(modelURL);
  displayFormMessage('Models loaded. Please wait.', 'info');
}

// --- VIDEO PROCTORING ---
function setVideoProctorAlert(isAlert) {
    const now = Date.now();
    if (isAlert && currentVideoProctorState === 'green') {
        if (greenStateStartTime) totalGreenStateDuration += (now - greenStateStartTime);
        videoRedAlertStartTime = now;
        currentVideoProctorState = 'red';
        proctorPreview.classList.remove('glow-green');
        proctorPreview.classList.add('glow-red');
    } else if (!isAlert && currentVideoProctorState === 'red') {
        if (videoRedAlertStartTime) totalVideoRedAlertDuration += (now - videoRedAlertStartTime);
        greenStateStartTime = now;
        currentVideoProctorState = 'green';
        proctorPreview.classList.remove('glow-red');
        proctorPreview.classList.add('glow-green');
    }
}
function isFaceStraight(landmarks) {
    const noseTip = landmarks.getNose()[3], leftEyeInner = landmarks.getLeftEye()[3], rightEyeInner = landmarks.getRightEye()[0];
    const dist = (p1, p2) => Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
    const dLeft = dist(noseTip, leftEyeInner), dRight = dist(noseTip, rightEyeInner);
    return dRight > 1 && (dLeft / dRight) > 0.6 && (dLeft / dRight) < 1.4;
}
function getEyeCenter(eye) { return { x: (eye[0].x + eye[3].x) / 2, y: (eye[1].y + eye[4].y) / 2 }; }
function getGazeAndEyeRatios(leftEye, rightEye) {
    const leftCenter = getEyeCenter(leftEye), rightCenter = getEyeCenter(rightEye);
    const getRatio = (p, c1, c2) => (p - c1) / (c2 - c1);
    return {
        gaze: { x: (leftCenter.x + rightCenter.x) / 2, y: (leftCenter.y + rightCenter.y) / 2 },
        eyeRatios: {
            left: { h: getRatio(leftCenter.x, leftEye[0].x, leftEye[3].x) },
            right: { h: getRatio(rightCenter.x, rightEye[0].x, rightEye[3].x) }
        }
    };
}
async function videoDetectLoop() {
    if (!proctoringActive) return;
    requestAnimationFrame(videoDetectLoop);
    if (proctorVideo.readyState < 2) return;
    const detection = await faceapi.detectSingleFace(proctorVideo, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks(true);
    proctorCtx.clearRect(0, 0, proctorCanvas.width, proctorCanvas.height);
    if (!detection || detection.detection.box.width < proctorCanvas.width * 0.35) return setVideoProctorAlert(true);
    const landmarks = detection.landmarks, leftEye = landmarks.getLeftEye(), rightEye = landmarks.getRightEye();
    if (!leftEye || !rightEye) return setVideoProctorAlert(true);
    const leftCenter = getEyeCenter(leftEye), rightCenter = getEyeCenter(rightEye);
    proctorCtx.strokeStyle = "lime"; proctorCtx.lineWidth = 2;
    [leftCenter, rightCenter].forEach(p => { proctorCtx.beginPath(); proctorCtx.arc(p.x, p.y, 10, 0, Math.PI * 2); proctorCtx.stroke(); });
    if (!isFaceStraight(landmarks)) { refGaze = refEyeRatios = null; return setVideoProctorAlert(true); }
    const { gaze, eyeRatios } = getGazeAndEyeRatios(leftEye, rightEye);
    if (!refGaze) { refGaze = gaze; refEyeRatios = eyeRatios; return setVideoProctorAlert(false); }
    if (Math.abs(gaze.x - refGaze.x) > 35 || Math.abs(gaze.y - refGaze.y) > 35) { refGaze = refEyeRatios = null; return setVideoProctorAlert(true); }
    if (Math.abs(eyeRatios.left.h - refEyeRatios.left.h) > 0.065 || Math.abs(eyeRatios.right.h - refEyeRatios.right.h) > 0.065) { refGaze = refEyeRatios = null; return setVideoProctorAlert(true); }
    setVideoProctorAlert(false);
}

// --- AUDIO PROCTORING (IMPROVED) ---
function setAudioProctorAlert(isAlert) {
    const now = Date.now();
    if (isAlert && currentAudioProctorState === 'green') {
        audioRedAlertStartTime = now;
        currentAudioProctorState = 'red';
    } else if (!isAlert && currentAudioProctorState === 'red') {
        if (audioRedAlertStartTime) totalAudioRedAlertDuration += (now - audioRedAlertStartTime);
        audioRedAlertStartTime = null;
        currentAudioProctorState = 'green';
    }
}
function startAudioProctoring(stream) {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    const bufferLength = analyser.fftSize;
    const dataArray = new Uint8Array(bufferLength);
    const source = audioCtx.createMediaStreamSource(stream);
    source.connect(analyser);

    audioCanvas.width = audioCanvas.offsetWidth * 2; // Increase resolution for crispness
    audioCanvas.height = audioCanvas.offsetHeight * 2;
    
    function drawAudioWave() {
        if (!proctoringActive) return;
        requestAnimationFrame(drawAudioWave);
        analyser.getByteTimeDomainData(dataArray);

        let sum = 0;
        for (let i = 0; i < bufferLength; i++) {
            sum += Math.abs(dataArray[i] - 128);
        }
        const volume = sum / bufferLength;
        
        const highThreshold = 5; // Human speech / loud sound
        const lowThreshold = 1.5; // Faint background noise

        let waveColor = "var(--lime)";
        let amplitude = 1;
        
        if (volume > highThreshold) {
            waveColor = "var(--red)";
            amplitude = 1 + (volume - highThreshold) / 5; // Make wave bigger for louder sounds
            setAudioProctorAlert(true);
        } else if (volume > lowThreshold) {
            waveColor = "var(--lime)";
            amplitude = 1;
            setAudioProctorAlert(false);
        } else {
            waveColor = "var(--lime)";
            amplitude = 0; // Flat line
            setAudioProctorAlert(false);
        }

        audioCanvasCtx.fillStyle = "rgba(7, 11, 26, 0.1)";
        audioCanvasCtx.fillRect(0, 0, audioCanvas.width, audioCanvas.height);
        audioCanvasCtx.lineWidth = 2.5;
        audioCanvasCtx.strokeStyle = waveColor;
        audioCanvasCtx.beginPath();
        
        const sliceWidth = audioCanvas.width * 1.0 / bufferLength;
        let x = 0;

        if (amplitude === 0) {
            audioCanvasCtx.moveTo(0, audioCanvas.height / 2);
            audioCanvasCtx.lineTo(audioCanvas.width, audioCanvas.height / 2);
        } else {
            for (let i = 0; i < bufferLength; i++) {
                const v = ((dataArray[i] - 128) * amplitude) / 128.0;
                const y = (v * audioCanvas.height / 2) + (audioCanvas.height / 2);
                i === 0 ? audioCanvasCtx.moveTo(x, y) : audioCanvasCtx.lineTo(x, y);
                x += sliceWidth;
            }
        }
        audioCanvasCtx.stroke();
    }
    drawAudioWave();
}

// --- START QUIZ & PROCTORING ---
async function startProctoringAndQuiz() {
    hideModal();
    startModal.style.display = 'grid';
    try {
        await loadModels();
        displayFormMessage('Requesting camera & microphone access...', 'info');
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: true });
        
        proctorVideo.srcObject = stream;
        proctorVideo.onloadedmetadata = () => {
            proctorVideo.play().then(() => {
                videoProctorContainer.style.display = 'flex';
                proctorCanvas.width = proctorVideo.videoWidth;
                proctorCanvas.height = proctorVideo.videoHeight;
                setVideoProctorAlert(false);
                greenStateStartTime = Date.now();
                videoDetectLoop();
                
                audioProctorContainer.style.display = 'flex';
                startAudioProctoring(stream);

                proctoringActive = true;
                startQuiz();
            });
        };
    } catch (err) {
        console.error("Media access error:", err);
        hideModal();
        startModal.style.display = 'none'; 
        showModal({
            title: "Permission Denied",
            body: `<p class="sub">Camera and Microphone access is required to start the test. Please allow access in your browser settings and try again.</p>`,
            confirmText: "Try Again",
            onConfirm: () => window.location.reload()
        });
    }
}

// ==========================================
//  QUIZ CORE LOGIC
// ==========================================

for (let i = 0; i < totalQ; i++) {
  const b = document.createElement('button');
  b.textContent = i + 1;
  b.className = 'btn ghost';
  b.onclick = () => loadQ(i);
  grid.appendChild(b);
}

function two(n) { return n < 10 ? '0' + n : '' + n; }
function fmt(sec) { const m = Math.floor(sec / 60), s = sec % 60; return `${two(m)}:${two(s)}`; }
function fmtMs(ms) { const totalSec = Math.floor(ms / 1000); return fmt(totalSec); }

function startTimer() {
  timerDisplay.textContent = fmt(remaining);
  timerId = setInterval(() => {
    remaining--;
    timerDisplay.textContent = fmt(Math.max(0, remaining));
    if (remaining <= 0) {
      clearInterval(timerId);
      finalize();
    }
  }, 1000);
}

function startQuiz() {
    startModal.style.display = 'none';
    enterFullScreen();
    startTs = Date.now();
    history.pushState(null, null, location.href);
    startTimer();
    loadQ(0);
}

function displayFormMessage(message, type = 'info') {
    formMessageEl.textContent = message;
    formMessageEl.className = `form-message ${type}`;
}

form.addEventListener('submit', (e) => {
    e.preventDefault();
    displayFormMessage(''); 
    const name = document.getElementById('name').value.trim(), college = document.getElementById('college').value.trim(), email = document.getElementById('email').value.trim(), collabId = document.getElementById('collabId').value.trim(), otp = document.getElementById('otp').value.trim();
    if (!name || !college || !email || !collabId || !otp) return displayFormMessage('Please fill all details.', 'error');
    if (!/^[^@\s]+@gmail\.com$/i.test(email)) return displayFormMessage('Please enter a valid Gmail address.', 'error');
    if (!(credentials.hasOwnProperty(collabId) && credentials[collabId] === otp)) return displayFormMessage('Incorrect ID or OTP.', 'error');
    if (collabId !== specialUser) {
        const now = new Date();
        if (now < accessStartTime) return displayFormMessage(`Access starts at ${accessStartTime.toLocaleTimeString('en-IN')}.`, 'info');
        if (now > accessEndTime) return displayFormMessage('Access time has expired.', 'error');
    }
    candidate = { name, college, email, aptId: collabId };
    const instructionsBody = `
      <ol class="instructions">
          <li>The test will run in fullscreen mode. Do not exit or switch tabs.</li>
          <li>You will have <b>60 minutes</b> for <b>50 questions</b>.</li>
          <li><b>Your face and activity will be monitored. Please allow camera permission.</b></li>
          <li><b>To detect surrounding sound, we need your audio access.</b></li>
          <li>After submitting, wait for the confirmation: "Your Data has been recorded".</li>
      </ol>
    `;

    showModal({ title: "Test Instructions", body: instructionsBody, confirmText: "I Understand", onConfirm: startProctoringAndQuiz });
    
    const confirmBtn = document.getElementById('modalConfirmBtn');
    confirmBtn.disabled = true;
    let countdown = 5;
    confirmBtn.textContent = `Please read carefully (${countdown})`;
    const countdownInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
            confirmBtn.textContent = `Please read carefully (${countdown})`;
        } else {
            clearInterval(countdownInterval);
            confirmBtn.disabled = false;
            confirmBtn.textContent = "I Understand, Start Now";
        }
    }, 1000);
});

finalSubmitBtn.onclick = () => {
    showModal({
        title: "Final Confirmation",
        body: `<p class="sub">You cannot go back after this. Are you sure you want to submit?</p>`,
        confirmText: "Submit Now",
        cancelText: "Cancel",
        onConfirm: () => { hideModal(); finalize(); },
        onCancel: hideModal
    });
};

function loadQ(idx) {
  iQ = idx;
  const data = QUESTIONS[iQ];
  qNumber.textContent = `Question ${iQ + 1} / ${totalQ}`;
  qText.textContent = data.q;
  optionsEl.innerHTML = '';
  const chosen = picked[iQ];
  data.a.forEach((opt, k) => {
    const btn = document.createElement('div');
    btn.className = 'opt';
    btn.textContent = String.fromCharCode(97 + k) + ') ' + opt;
    if (chosen !== null) {
      if (k === data.c) btn.classList.add('correct');
      else if (k === chosen) btn.classList.add('wrong');
    }
    btn.onclick = () => select(iQ, k);
    optionsEl.appendChild(btn);
  });
  prevBtn.disabled = (iQ === 0);
  if (iQ === totalQ - 1) { nextBtn.style.display = 'none'; finalSubmitContainer.style.display = 'block'; } 
  else { nextBtn.style.display = 'inline-flex'; finalSubmitContainer.style.display = 'none'; }
  updateHUD();
  highlightJump();
}

function select(qIndex, k) {
  if (picked[qIndex] !== null) return;
  picked[qIndex] = k;
  loadQ(qIndex);
}

prevBtn.onclick = () => { if (iQ > 0) loadQ(iQ - 1); };
nextBtn.onclick = () => { if (iQ < totalQ - 1) loadQ(iQ + 1); };

function updateHUD() {
  let attemptedCount = picked.filter(x => x !== null).length;
  let correctCount = picked.filter((choice, idx) => choice !== null && choice === QUESTIONS[idx].c).length;
  attemptedEl.textContent = attemptedCount;
  correctEl.textContent = correctCount;
  bar.style.width = Math.round((attemptedCount / totalQ) * 100) + '%';
}

function highlightJump() {
  grid.childNodes.forEach((b, idx) => {
    const choice = picked[idx];
    let borderColor = 'var(--stroke)', bg = 'transparent', color = 'var(--muted)';
    if (choice !== null) { color = '#fff'; borderColor = 'rgba(60, 246, 138, .8)'; bg = 'rgba(60, 246, 138, .12)'; }
    if (idx === iQ) { bg = 'linear-gradient(90deg, var(--cyan), var(--fus))'; color = '#fff'; }
    b.style.borderColor = borderColor; b.style.background = bg; b.style.color = color;
  });
}

function finalize() {
  if (quizFinalized) return;
  quizFinalized = true;
  if (timerId) clearInterval(timerId);
  proctoringActive = false;
  if (proctorVideo.srcObject) { proctorVideo.srcObject.getTracks().forEach(track => track.stop()); }
  videoProctorContainer.style.display = 'none';
  audioProctorContainer.style.display = 'none';

  const now = Date.now();
  if (currentVideoProctorState === 'green' && greenStateStartTime) totalGreenStateDuration += (now - greenStateStartTime);
  if (currentVideoProctorState === 'red' && videoRedAlertStartTime) totalVideoRedAlertDuration += (now - videoRedAlertStartTime);
  if (currentAudioProctorState === 'red' && audioRedAlertStartTime) totalAudioRedAlertDuration += (now - audioRedAlertStartTime);
  
  const totalTestDuration = startTs ? now - startTs : 0;
  const totalAudioOKDuration = totalTestDuration > totalAudioRedAlertDuration ? totalTestDuration - totalAudioRedAlertDuration : 0;

  if(document.fullscreenElement) { document.exitFullscreen(); }

  let correctAnswers = picked.filter((choice, idx) => choice !== null && choice === QUESTIONS[idx].c).length;
  let attemptedAnswers = picked.filter(x => x !== null).length;
  let wrongAnswers = attemptedAnswers - correctAnswers;
  let scorePercent = attemptedAnswers > 0 ? (correctAnswers / attemptedAnswers) * 100 : 0;
  
  document.querySelector('.quiz-wrap').style.display = 'none';
  resultPanel.style.display = 'block';

  rName.textContent = candidate.name;
  rCollege.textContent = candidate.college;
  rAptId.textContent = candidate.aptId;
  rAttempted.textContent = attemptedAnswers;
  rCorrect.textContent = correctAnswers;
  rScore.textContent = `${correctAnswers}/${totalQ}`;
  rProctorOK.textContent = `${fmtMs(totalGreenStateDuration)} / ${fmtMs(totalAudioOKDuration)}`;
  rProctorAlerts.textContent = `${fmtMs(totalVideoRedAlertDuration)} / ${fmtMs(totalAudioRedAlertDuration)}`;
  
  const elapsedSec = 60 * 60 - remaining; 
  timeUsed.textContent = fmt(elapsedSec);

  if (TG.enabled) {
    const text = `
📢 **New Quiz Submission**
👤 **Name:** ${candidate.name}
🏫 **College:** ${candidate.college}
🆔 **Collab99 ID:** ${candidate.aptId}
---
✅ Correct: ${correctAnswers}
❌ Wrong: ${wrongAnswers}
📊 **Score: ${scorePercent.toFixed(2)}%**
---
⏱️ Time Used: ${fmt(elapsedSec)}
---
👁️🎙️ **Proctoring Report**
- ✅ OK (Face/Audio): ${fmtMs(totalGreenStateDuration)} / ${fmtMs(totalAudioOKDuration)}
- ⚠️ Alerts (Face/Audio): ${fmtMs(totalVideoRedAlertDuration)} / ${fmtMs(totalAudioRedAlertDuration)}
`;
    const url = `https://api.telegram.org/bot${TG.BOT_TOKEN}/sendMessage`;
    fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: TG.CHAT_ID, text: text.replace(/<br\s*\/?>/gi, '\n'), parse_mode: 'Markdown' })
      })
      .then(r => r.ok ? successAnimation.style.display = 'block' : Promise.reject())
      .catch(() => {
        successAnimation.innerHTML = '<p style="color: var(--red);">Error: Could not send results. Please save a PDF copy.</p>';
        successAnimation.style.display = 'block';
      });
  } else {
    successAnimation.innerHTML = '<p>Telegram sending is disabled. Please save a PDF copy.</p>';
    successAnimation.style.display = 'block';
  }
}

window.onload = () => {
  qText.textContent = 'Fill your details to start the quiz. Good luck!';
};
</script>
</body>
</html>
